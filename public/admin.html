<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Qu·∫£n l√Ω ng∆∞·ªùi d√πng</title>
  <style>
    table { width: 80%; margin: 40px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    thead th { background: #1e66ff; color: #fff; }
    .btn-delete { background:#ff4d4f; color:#fff; border:none; padding:6px 10px; cursor:pointer; }
  </style>
</head>
<body>
  <h2 style="text-align:center">üëë Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h2>

  <table>
    <thead>
      <tr>
        <th>T√™n</th>
        <th>Email</th>
        <th>Role</th>
        <th>H√†nh ƒë·ªông</th>
      </tr>
    </thead>
    <tbody id="userTableBody"><!-- H√ÄNG S·∫º ƒê∆Ø·ª¢C ƒê·ªî V√ÄO ƒê√ÇY --></tbody>
  </table>

  <!-- ƒê·∫∂T SCRIPT SAU B·∫¢NG -->
  <script>
  window.addEventListener('DOMContentLoaded', async () => {
    const tableBody = document.getElementById('userTableBody'); // PH·∫¢I T·ªíN T·∫†I
    if (!tableBody) {
      alert('Thi·∫øu <tbody id="userTableBody"> trong admin.html');
      return;
    }

    const token = localStorage.getItem('jwt');
    if (!token) {
      alert('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p. Chuy·ªÉn t·ªõi /login');
      return location.href = '/login';
    }

    try {
      const res = await fetch('/users', {
        headers: { 'Authorization': 'Bearer ' + token }
      });

      if (res.status === 401) {
        alert('Token h·∫øt h·∫°n/thi·∫øu. ƒêƒÉng nh·∫≠p l·∫°i.');
        return location.href = '/login';
      }
      if (res.status === 403) {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn Admin.');
        return;
      }
      if (!res.ok) throw new Error(await res.text() || 'L·ªói khi t·∫£i danh s√°ch');

      const data = await res.json();
      const users = Array.isArray(data) ? data : (data.users || []);
      tableBody.innerHTML = '';

      users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${u.name || ''}</td>
          <td>${u.email || ''}</td>
          <td>${u.role || 'user'}</td>
          <td><button class="btn-delete" data-id="${u._id}">Xo√°</button></td>
        `;
        tableBody.appendChild(tr);
      });

      tableBody.addEventListener('click', async (e) => {
        const btn = e.target.closest('.btn-delete');
        if (!btn) return;
        const id = btn.dataset.id;
        if (!confirm('Ch·∫Øc ch·∫Øn xo√° user n√†y?')) return;

        const del = await fetch('/users/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (del.ok) btn.closest('tr').remove();
        else alert('Xo√° th·∫•t b·∫°i: ' + (await del.text()));
      });
    } catch (e) {
      alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch: ' + e.message);
      console.error(e);
    }
  });
  </script>
</body>
</html>
